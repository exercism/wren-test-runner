#!/usr/bin/env sh

# Synopsis:
# Test the test runner by running it against a predefined set of solutions
# with an expected output.

# Output:
# Outputs the diff of the expected test results against the actual test results
# generated by the test runner.

# Example:
# ./bin/run-tests.sh

exit_code=0

# Iterate over all test directories
for test_dir in tests/*; do
    test_dir_name=$(basename "${test_dir}")
    test_dir_path=$(realpath "${test_dir}")
    input_path="${test_dir_path}/input/"
    results_file_path="${test_dir_path}/results.json"
    expected_results_file_path="${test_dir_path}/expected_results.json"

    # this is needed because we clobber the input directory (rewriting tests to
    # disable skip) during the process of running tests so we don't want to
    # actually destroy our source code (and risk that getting checked into Git
    # accidentally)
    TMP_INPUT_DIR=$(mktemp -d)
    # I couldn't get cp -R to work consistently on both Mac OS X and Linux
    rsync -r ${input_path} $TMP_INPUT_DIR

    slug=$test_dir_name

    echo "TESTING: ${test_dir_name}"
    bin/run.sh "${slug}" "${TMP_INPUT_DIR}" "${test_dir_path}" > /dev/null

    status=$?

    # echo "${test_dir_name}: comparing results.json to expected_results.json"
    diff -urN "${expected_results_file_path}" "${results_file_path}"
    if [ $? -ne 0 ]; then
        exit_code=1
    fi
    if [ $status -ne 0 ]; then
        exit_code=1
    fi
    rm -f ${results_file_path}
done

exit ${exit_code}
